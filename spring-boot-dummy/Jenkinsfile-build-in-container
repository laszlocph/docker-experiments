node ('master'){
    checkout scm
    stage ('Build Building container') {
        dir('spring-boot-dummy') {
            sh 'sudo docker build --build-arg user=$(id -u) -t laszlocph/build-spring-boot-dummy .'
        }
    }
    stage ('Build in Container') {
        dir('spring-boot-dummy') {

            def CONTAINER_ID = sh (
                    script: "sudo docker run -d -u \$(id -u) --network=host laszlocph/build-spring-boot-dummy",
                    returnStatus: true
            ) == 0
            echo "Container id: ${CONTAINER_ID}"

            sh 'sudo docker exec ${vars.CONTAINER_ID} ./gradlew build'
            sh 'sudo docker cp ${vars.CONTAINER_ID}:/spring-boot-dummy/build/libs/spring-boot-dummy-0.1.0.jar docker/spring-boot-dummy-0.1.0.jar'
            sh 'sudo docker stop ${vars.CONTAINER_ID}'
            sh 'sudo docker rm ${vars.CONTAINER_ID}'
            sh 'ls -la'
        }
    }

    stage ('Build Container with latest Build') {
        dir('spring-boot-dummy/docker') {
            sh 'sudo docker build -t laszlocph/spring-boot-dummy:latest .'
        }
    }
}
